name: release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

env:
  MODRINTH_API_KEY: ${{ secrets.MODRINTH_API_KEY }}
  CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
  TEST_PUBLISHING_WITH_MR_STAGING: ${{ vars.TEST_PUBLISHING_WITH_MR_STAGING }}

jobs:
  build:
    name: Build Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build artifacts
        run: ./gradlew clean build --stacktrace

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/

  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    outputs:
      publish_github: ${{ steps.sync-props.outputs.publish_github }}
      changed: ${{ steps.sync-props.outputs.changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Generate changelog with git-cliff
        id: cliff
        uses: orhun/git-cliff-action@v3
        with:
          tag: ${{ github.ref_name }}
          output: CHANGELOG.md

      - name: Sync gradle.properties with tag
        id: sync-props
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME:-$(git describe --tags --abbrev=0)}"
          echo "Syncing gradle.properties for tag $TAG"

          VERSION=$(grep '^mod.version=' gradle.properties | cut -d'=' -f2)
          CHANNEL_TAG=$(grep '^mod.channel_tag=' gradle.properties | cut -d'=' -f2)
          PUBLISH_GITHUB=$(grep '^publish.github=' gradle.properties | cut -d'=' -f2 || echo "false")
          FULL_VERSION="${VERSION}${CHANNEL_TAG}"

          echo "- mod.version: ${VERSION}"
          echo "- mod.channel_tag: ${CHANNEL_TAG}"
          echo "- Combined: ${FULL_VERSION}"

          if [[ "$FULL_VERSION" != "$TAG" ]]; then
            echo "Updating gradle.properties to match tag..."
            BASE_VERSION=$(echo "$TAG" | sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
            CHANNEL=$(echo "$TAG" | sed -E "s/^${BASE_VERSION}//")
            sed -i "s/^mod.version=.*/mod.version=${BASE_VERSION}/" gradle.properties
            sed -i "s/^mod.channel_tag=.*/mod.channel_tag=${CHANNEL}/" gradle.properties
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

          echo "publish_github=$PUBLISH_GITHUB" >> "$GITHUB_OUTPUT"

      - name: Commit version changes if needed
        if: steps.sync-props.outputs.changed == 'true' && steps.sync-props.outputs.publish_github == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add gradle.properties
          git commit -m "chore(release): sync gradle.properties with tag ${GITHUB_REF_NAME}"
          git push

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.publish_github == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: .

      - name: Create or update GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "Creating or updating release for $TAG"
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file CHANGELOG.md \
            --latest \
            --verify-tag \
            --clobber \
            ./build/libs/* || {
              echo "Updating existing release..."
              gh release edit "$TAG" \
                --notes-file CHANGELOG.md \
                --latest \
                --clobber
              gh release upload "$TAG" ./build/libs/* --clobber
            }

  publish-modrinth:
    name: Publish to Modrinth
    runs-on: ubuntu-latest
    needs: [ prepare, github-release ]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Publish to Modrinth (if available)
        run: |
          if ./gradlew tasks --all | grep -q "publishModrinth"; then
            echo "Running publishModrinth..."
            ./gradlew publishModrinth --stacktrace
          else
            echo "Skipping Modrinth publish, task not found."
          fi

  publish-curseforge:
    name: Publish to Curseforge
    runs-on: ubuntu-latest
    needs: [ prepare, github-release ]
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Publish to Curseforge (if available)
        run: |
          if ./gradlew tasks --all | grep -q "publishCurseforge"; then
            echo "Running publishCurseforge..."
            ./gradlew publishCurseforge --stacktrace
          else
            echo "Skipping Curseforge publish, task not found."
          fi
